{% liquid
  assign comp_field = product.metafields['shopify--discovery']['product_recommendation.complementary_products'].value
  if comp_field == blank
    assign comp_field = product.metafields.shopify--discovery['product_recommendation.complementary_products'].value
  endif
  assign comp_products = comp_field | default: []
  assign comp_product = comp_products | first
%}
{% if comp_product and comp_product.id != product.id %}
  {% assign total_price = product.selected_or_first_available_variant.price | plus: comp_product.selected_or_first_available_variant.price %}
  <complementary-bundle class="cb" data-main-id="{{ product.selected_or_first_available_variant.id }}" data-comp-id="{{ comp_product.selected_or_first_available_variant.id }}" data-redirect="{{ section.settings.redirect_to_cart }}" data-success="{{ section.settings.success_message }}">
    <h3 class="cb__head">{{ section.settings.heading }}</h3>
    <div class="cb__grid">
      <div class="cb__prod cb__main">
        <div class="cb__img">
          {% if product.featured_image %}
            <img src="{{ product.featured_image | image_url: width: 160 }}" alt="{{ product.featured_image.alt | escape }}">
          {% endif %}
        </div>
        <div>
          <div class="cb__title">{{ product.title }}</div>
          <div class="cb__price" data-main-price>{{ product.selected_or_first_available_variant.price | money }}</div>
        </div>
      </div>
      <div class="cb__plus" aria-hidden="true">+</div>
      <div class="cb__prod cb__comp">
        <div class="cb__img">
          {% if comp_product.featured_image %}
            <img src="{{ comp_product.featured_image | image_url: width: 160 }}" alt="{{ comp_product.featured_image.alt | escape }}">
          {% endif %}
        </div>
        <div>
          <div class="cb__title">{{ comp_product.title }}</div>
          <div class="cb__price" data-comp-price>{{ comp_product.selected_or_first_available_variant.price | money }}</div>
          {% if section.settings.show_variant_picker and comp_product.variants.size > 1 %}
            <div class="cb__opts">
              {% for option in comp_product.options_with_values %}
                <label class="visually-hidden" for="cb-{{ section.id }}-option-{{ forloop.index }}">{{ option.name }}</label>
                <select id="cb-{{ section.id }}-option-{{ forloop.index }}" data-comp-select>
                  {% for value in option.values %}
                    <option value="{{ value }}" {% if option.selected_value == value %}selected{% endif %}>{{ value }}</option>
                  {% endfor %}
                </select>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="cb__row">
      <span class="cb__price cb__total" data-total-price>{{ total_price | money }}</span>
      <button type="button" class="cb__cta" data-bundle-add{% unless product.available and comp_product.available %} disabled{% endunless %}>{{ section.settings.cta_label }}</button>
    </div>
    <p class="cb__note" role="status" data-bundle-status></p>
    <script type="application/json" data-main-variants>{{ product.variants | json }}</script>
    <script type="application/json" data-comp-variants>{{ comp_product.variants | json }}</script>
  </complementary-bundle>
  {{ 'complementary-bundle.css' | asset_url | stylesheet_tag }}
  {{ 'complementary-bundle.js' | asset_url | script_tag }}
{% endif %}

{% schema %}
{
  "name": "Complementary bundle",
  "tag": "section",
  "settings": [
    {"type": "text", "id": "heading", "label": "Heading", "default": "Bundle-Angebot"},
    {"type": "text", "id": "cta_label", "label": "Button label", "default": "Beide in den Warenkorb"},
    {"type": "checkbox", "id": "show_variant_picker", "label": "Show variant picker", "default": false},
    {"type": "checkbox", "id": "redirect_to_cart", "label": "Redirect to cart after adding", "default": false},
    {"type": "range", "id": "max_items", "label": "Maximum complementary products", "min": 1, "max": 4, "step": 1, "default": 1},
    {"type": "text", "id": "success_message", "label": "Success message", "default": "Bundle in den Warenkorb gelegt!"}
  ],
  "blocks": [],
  "presets": [{"name": "Complementary bundle"}]
}
{% endschema %}
