{%- liquid
  assign complementary = product.metafields['shopify--discovery']['product_recommendation.complementary_products'].value
  if complementary == blank
    assign complementary = product.metafields.shopify--discovery['product_recommendation.complementary_products'].value
  endif
  assign complementary = complementary | slice: 0, section.settings.max_items
  if complementary.size > 0
    assign comp_product = complementary.first
  endif
-%}
{%- if comp_product and comp_product.id != product.id -%}
  {{ 'complementary-bundle.css' | asset_url | stylesheet_tag }}
  {{ 'complementary-bundle.js' | asset_url | script_tag }}
  <div class="cb" data-section-type="complementary-bundle" data-section-id="{{ section.id }}">
    <h3 class="cb__head">{{ section.settings.heading }}</h3>
    <div class="cb__grid">
      <div class="cb__prod cb__prod--main">
        <div class="cb__img">
          {{ product.featured_media | image_url: width: 200 | image_tag: loading: 'lazy' }}
        </div>
        <div>
          <div class="cb__title">{{ product.title }}</div>
          <div class="cb__price js-cb-main-price">
            {{ product.selected_or_first_available_variant.price | money }}
          </div>
        </div>
      </div>
      <div class="cb__plus" aria-hidden="true">+</div>
      <div class="cb__prod cb__prod--comp">
        <div class="cb__img">
          {{ comp_product.featured_media | image_url: width: 200 | image_tag: loading: 'lazy' }}
        </div>
        <div>
          <div class="cb__title">{{ comp_product.title }}</div>
          <div class="cb__price js-cb-comp-price">
            {{ comp_product.selected_or_first_available_variant.price | money }}
          </div>
          {%- if section.settings.show_variant_picker and comp_product.options.size > 1 -%}
            <div class="cb__opts">
              {%- for option in comp_product.options_with_values -%}
                <label class="visually-hidden" for="cb-opt-{{ section.id }}-{{ forloop.index0 }}">{{ option.name }}</label>
                <select id="cb-opt-{{ section.id }}-{{ forloop.index0 }}" class="cb__select" data-option-index="{{ forloop.index0 }}">
                  {%- for value in option.values -%}
                    <option value="{{ value | escape }}">{{ value }}</option>
                  {%- endfor -%}
                </select>
              {%- endfor -%}
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
    <div class="cb__row">
      <div class="cb__price js-cb-total-price">
        {{ (product.selected_or_first_available_variant.price | plus: comp_product.selected_or_first_available_variant.price) | money }}
      </div>
      <button type="button" class="cb__cta js-cb-atc"{%- unless product.selected_or_first_available_variant.available and comp_product.available -%} disabled{%- endunless -%}>
        Beide in den Warenkorb
      </button>
    </div>
    <div class="cb__note js-cb-message" role="status" aria-live="polite"></div>
  </div>
  <script type="application/json" id="cb-{{ section.id }}-data">
    {{ comp_product | json }}
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Complementary bundle",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Bundle & save"
    },
    {
      "type": "checkbox",
      "id": "show_variant_picker",
      "label": "Show variant selector for complementary product",
      "default": true
    },
    {
      "type": "range",
      "id": "max_items",
      "label": "Maximum products",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 1
    }
  ],
  "presets": [
    {
      "name": "Complementary bundle"
    }
  ]
}
{% endschema %}

