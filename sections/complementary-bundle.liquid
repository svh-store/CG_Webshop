{% liquid
  assign comp = product.metafields['shopify--discovery']['product_recommendation.complementary_products'].value
  if comp == blank
    assign comp = product.metafields.shopify--discovery['product_recommendation.complementary_products'].value
  endif
  if comp == blank
    assign comp_products = nil
  else
    assign comp_products = comp | slice: 0, section.settings.max_items
  endif
  assign comp_product = comp_products | first
  if comp_product and comp_product.id == product.id
    assign comp_product = nil
  endif
%}
{% if comp_product %}
  <link rel="stylesheet" href="{{ 'complementary-bundle.css' | asset_url }}">
  <div class="cb js-complementary-bundle" data-main-variant-id="{{ product.selected_or_first_available_variant.id }}">
    <h2 class="cb__head">{{ section.settings.heading }}</h2>
    <div class="cb__grid">
      <div class="cb__prod">
        <div class="cb__img">
          {% if product.featured_image %}<img src="{{ product.featured_image | img_url: '160x160' }}" alt="{{ product.featured_image.alt | default: product.title | escape }}">{% endif %}
        </div>
        <div>
          <div class="cb__title">{{ product.title }}</div>
          <div class="cb__price" data-main-price="{{ product.selected_or_first_available_variant.price }}">{{ product.selected_or_first_available_variant.price | money }}</div>
        </div>
      </div>
      <div class="cb__plus">{% render 'icon-plus' %}</div>
      <div class="cb__prod">
        <div class="cb__img">
          {% if comp_product.featured_image %}<img src="{{ comp_product.featured_image | img_url: '160x160' }}" alt="{{ comp_product.featured_image.alt | default: comp_product.title | escape }}">{% endif %}
        </div>
        <div>
          <div class="cb__title">{{ comp_product.title }}</div>
          <div class="cb__price" data-comp-price="{{ comp_product.selected_or_first_available_variant.price }}">{{ comp_product.selected_or_first_available_variant.price | money }}</div>
          {% if section.settings.show_variant_picker and comp_product.variants.size > 1 %}
            <div class="cb__opts">
              {% for option in comp_product.options_with_values %}
                <label class="visually-hidden" for="cb-option-{{ section.id }}-{{ forloop.index0 }}">{{ option.name }}</label>
                <select id="cb-option-{{ section.id }}-{{ forloop.index0 }}" class="cb__selector" data-option-index="{{ forloop.index0 }}">
                  {% assign current_val = comp_product.selected_or_first_available_variant.options[forloop.index0] %}
                  {% for value in option.values %}
                    <option value="{{ value | escape }}" {% if value == current_val %}selected{% endif %}>{{ value }}</option>
                  {% endfor %}
                </select>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="cb__row">
      <div class="cb__note">{{ 'cart.general.total' | t }}: <span data-total-price>{{ (product.selected_or_first_available_variant.price | plus: comp_product.selected_or_first_available_variant.price) | money }}</span></div>
      <button type="button" class="cb__cta" data-success="{{ 'products.product.added_to_cart' | t }}">{{ section.settings.button_label }}</button>
    </div>
    <p class="visually-hidden" role="status"></p>
    <script type="application/json" data-comp-variants>
      {{ comp_product.variants | json }}
    </script>
  </div>
  <script src="{{ 'complementary-bundle.js' | asset_url }}" defer="defer"></script>
{% endif %}
{% schema %}
{
  "name": "Complementary bundle",
  "settings": [
    {"type":"text","id":"heading","label":"Heading","default":"Empfohlenes Bundle"},
    {"type":"checkbox","id":"show_variant_picker","label":"Show complementary variant picker","default":true},
    {"type":"number","id":"max_items","label":"Max items","min":1,"max":4,"default":1},
    {"type":"text","id":"button_label","label":"Button label","default":"Beide in den Warenkorb"}
  ],
  "presets": [
    {"name":"Complementary bundle"}
  ]
}
{% endschema %}
