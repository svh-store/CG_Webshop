{%- comment -%}
CG Bundle Inline (Custom HTML/Liquid)
- Hauptprodukt + erstes Complementary-Produkt
- Mengen entfernt (immer 1 + 1)
- Gesamtpreis im CTA-Bereich (rechts), live bei Variantwechsel
{%- endcomment -%}

{%- assign heading = heading | default: 'Passend dazu – im Bundle' -%}
{%- assign allow_variant_select = allow_variant_select | default: true -%}
{%- assign debug = debug | default: false -%}

{%- assign comps_namespace = 'shopify--discovery' -%}
{%- assign comps_key = 'product_recommendation.complementary_products' -%}
{%- assign metafield_obj = product.metafields[comps_namespace][comps_key] -%}
{%- assign comps = metafield_obj.value -%}

<section class="cg-bundle" data-cg-bundle data-product-id="{{ product.id }}"
  data-allow-variant="{{ allow_variant_select }}"
  data-debug="{{ debug }}"
  data-money-format='{{ shop.money_format | json }}'
  data-currency='{{ shop.currency | json }}'>
  <h3 class="cg-bundle__heading">{{ heading }}</h3>

  <div class="cg-bundle__wrap" data-role="wrap">
    <!-- Hauptprodukt -->
    <div class="cg-bundle__item cg-bundle__item--main"
         data-main-price="{{ product.selected_or_first_available_variant.price }}"
         data-main-compare="{{ product.selected_or_first_available_variant.compare_at_price | default: 0 }}"
         data-main-variant-id="{{ product.selected_or_first_available_variant.id }}">
      <div class="cg-bundle__media">
        {%- assign main_img = product.featured_image | default: product.images.first -%}
        {%- if main_img -%}
          {{ main_img
            | image_url: width: 720
            | image_tag:
                alt: product.title,
                loading: 'lazy',
                class: 'cg-bundle__img',
                sizes: '(min-width:980px) 96px, 33vw',
                widths: '96,144,192,288,384,576'
          }}
        {%- endif -%}
      </div>
      <div class="cg-bundle__info">
        <div class="cg-bundle__title">{{ product.title }}</div>
        {%- assign v = product.selected_or_first_available_variant -%}
        <div class="cg-bundle__price">
          {%- if v.compare_at_price > v.price -%}
            <span class="cg-bundle__price--sale">{{ v.price | money }}</span>
            <s class="cg-bundle__price--compare">{{ v.compare_at_price | money }}</s>
          {%- else -%}
            <span>{{ v.price | money }}</span>
          {%- endif -%}
        </div>
      </div>
    </div>

    <div class="cg-bundle__plus" aria-hidden="true">+</div>

    <!-- Ergänzendes Produkt -->
    <div class="cg-bundle__item cg-bundle__item--comp" data-role="comp">
      {%- if comps != blank and comps.size > 0 -%}
        {%- assign comp = comps | first -%}
        {%- assign comp_variant = comp.selected_or_first_available_variant -%}

        <div class="cg-bundle__media">
          {%- assign comp_img = comp.featured_image | default: comp.images.first -%}
          {%- if comp_img -%}
            {{ comp_img
              | image_url: width: 720
              | image_tag:
                  alt: comp.title,
                  loading: 'lazy',
                  class: 'cg-bundle__img',
                  sizes: '(min-width:980px) 96px, 33vw',
                  widths: '96,144,192,288,384,576'
            }}
          {%- endif -%}
        </div>

        <div class="cg-bundle__info"
             data-comp-product-id="{{ comp.id }}"
             data-comp-variant-id="{{ comp_variant.id }}"
             data-comp-price="{{ comp_variant.price }}"
             data-comp-compare="{{ comp_variant.compare_at_price | default: 0 }}">
          <div class="cg-bundle__title">{{ comp.title }}</div>

          {%- if comp.variants.size > 1 and allow_variant_select -%}
            <label class="cg-bundle__select">
              <span>Variante</span>
              <select data-role="comp-variant">
                {%- for vv in comp.variants -%}
                  <option value="{{ vv.id }}"
                          data-price="{{ vv.price }}"
                          data-compare="{{ vv.compare_at_price | default: 0 }}"
                          {% if vv.available %}{% else %}disabled{% endif %}
                          {% if vv.id == comp_variant.id %}selected{% endif %}>
                    {{ vv.title }}{% unless vv.available %} – ausverkauft{% endunless %}
                  </option>
                {%- endfor -%}
              </select>
            </label>
          {%- else -%}
            <input type="hidden" data-role="comp-variant" value="{{ comp_variant.id }}"
                   data-price="{{ comp_variant.price }}"
                   data-compare="{{ comp_variant.compare_at_price | default: 0 }}">
          {%- endif -%}

          <div class="cg-bundle__price">
            {%- if comp_variant.compare_at_price > comp_variant.price -%}
              <span class="cg-bundle__price--sale">{{ comp_variant.price | money }}</span>
              <s class="cg-bundle__price--compare">{{ comp_variant.compare_at_price | money }}</s>
            {%- else -%}
              <span>{{ comp_variant.price | money }}</span>
            {%- endif -%}
          </div>
        </div>
      {%- else -%}
        <!-- Platzhalter; JS-Fallback füllt (mit Bild) -->
        <div class="cg-bundle__info" data-role="comp-empty">
          <div class="cg-bundle__title">Wird geladen …</div>
        </div>
      {%- endif -%}
    </div>
  </div>

  <div class="cg-bundle__cta">
    <div class="cg-bundle__total">
      <span>Gesamt:</span>
      <strong data-role="bundle-total">–</strong>
    </div>
    <button type="button" class="cg-bundle__btn" data-role="bundle-add">Beide in den Warenkorb</button>
    <div class="cg-bundle__msg" aria-live="polite"></div>
  </div>
</section>

<script>
(() => {
  const root = document.currentScript.previousElementSibling;
  if (!root || !root.matches('[data-cg-bundle]')) return;

  const DEBUG = root.getAttribute('data-debug') === 'true';
  const moneyFormat = JSON.parse(root.getAttribute('data-money-format') || '"€{{amount}}"');
  const currency = JSON.parse(root.getAttribute('data-currency') || '"EUR"');

  function log(...args){ if(DEBUG) console.log('[CG-BUNDLE]', ...args); }

  function formatMoney(cents){
    if (window.Shopify && typeof Shopify.formatMoney === 'function') {
      return Shopify.formatMoney(cents, moneyFormat);
    }
    try {
      return new Intl.NumberFormat(undefined, {style:'currency', currency}).format(cents/100);
    } catch {
      return (cents/100).toFixed(2) + ' ' + currency;
    }
  }

  function getCurrentMainVariantId() {
    const idInput = document.querySelector('form[action*="/cart/add"] input[name="id"]');
    if (idInput && idInput.value) return parseInt(idInput.value, 10);
    return parseInt(root.querySelector('[data-main-variant-id]').getAttribute('data-main-variant-id'), 10);
  }

  function getMainPriceCents(){
    const el = root.querySelector('[data-main-price]');
    return parseInt(el.getAttribute('data-main-price') || '0', 10);
  }

  function getCompPriceCents(){
    const input = root.querySelector('[data-role="comp-variant"]');
    const price = input?.selectedOptions?.[0]?.getAttribute('data-price') || input?.getAttribute?.('data-price') || '0';
    return parseInt(price, 10);
  }

  function updateTotal(){
    const totalEl = root.querySelector('[data-role="bundle-total"]');
    const total = getMainPriceCents() + getCompPriceCents();
    totalEl.textContent = formatMoney(total);
  }

  // Fallback: Recommendations API (inkl. Bild)
  async function fetchComplementaryFallback() {
    const pid = root.getAttribute('data-product-id');
    const url = `/recommendations/products.json?product_id=${pid}&intent=complementary&limit=4`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('recommendations fetch failed');
    const data = await res.json();
    return Array.isArray(data.products) ? data.products : data;
  }

  function renderCompFromAPI(p) {
    const wrap = root.querySelector('[data-role="comp"]');
    const allowVariant = root.getAttribute('data-allow-variant') === 'true';

    const img = (p.featured_image && p.featured_image.url) || (p.images && p.images[0] && p.images[0].url) || '';
    const mediaHTML = img ? `<img src="${img}&width=384" width="96" height="96" class="cg-bundle__img" alt="${p.title}">` : '';

    const firstVar = (p.variants && p.variants.length) ? p.variants[0] : null;

    let variantHTML = '';
    if (allowVariant && p.variants && p.variants.length > 1) {
      variantHTML = `
        <label class="cg-bundle__select">
          <span>Variante</span>
          <select data-role="comp-variant">
            ${p.variants.map(v =>
              `<option value="${v.id}" data-price="${v.price}" ${v.available ? '' : 'disabled'}>${v.title}${v.available ? '' : ' – ausverkauft'}</option>`
            ).join('')}
          </select>
        </label>`;
    } else if (firstVar) {
      variantHTML = `<input type="hidden" data-role="comp-variant" value="${firstVar.id}" data-price="${firstVar.price}">`;
    }

    const price = firstVar ? formatMoney(firstVar.price) : '';
    const compare = (firstVar && firstVar.compare_at_price && firstVar.compare_at_price > firstVar.price)
      ? `<s class="cg-bundle__price--compare">${formatMoney(firstVar.compare_at_price)}</s>` : '';

    wrap.innerHTML = `
      <div class="cg-bundle__media">${mediaHTML}</div>
      <div class="cg-bundle__info" data-comp-product-id="${p.id}">
        <div class="cg-bundle__title">${p.title}</div>
        <div class="cg-bundle__price">
          <span class="cg-bundle__price--sale">${price}</span>${compare}
        </div>
        ${variantHTML}
      </div>`;
  }

  async function ensureCompExists() {
    const empty = root.querySelector('[data-role="comp-empty"]');
    if (!empty) { updateTotal(); return; }
    try {
      const list = await fetchComplementaryFallback();
      const first = Array.isArray(list) ? list[0] : (list.products && list.products[0]);
      if (first) {
        renderCompFromAPI(first);
        updateTotal();
        const sel = root.querySelector('[data-role="comp-variant"]');
        sel && sel.addEventListener('change', updateTotal);
      } else {
        empty.innerHTML = '<div class="cg-bundle__title">Kein Ergänzungsprodukt gefunden.</div>';
      }
    } catch(e) {
      empty.innerHTML = '<div class="cg-bundle__title">Ergänzungsprodukt konnte nicht geladen werden.</div>';
    }
  }

  async function addBothToCart() {
    const btn = root.querySelector('[data-role="bundle-add"]');
    const msg = root.querySelector('.cg-bundle__msg');
    const compVariantEl = root.querySelector('[data-role="comp-variant"]');
    const compVariantId = compVariantEl ? parseInt(compVariantEl.value, 10) : null;
    const mainVariantId = getCurrentMainVariantId();
    if (!compVariantId) { msg.textContent = 'Bitte Variante wählen.'; return; }

    btn.disabled = true; msg.textContent = 'Wird hinzugefügt …';
    try {
      const res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({
          items: [
            { id: mainVariantId, quantity: 1 },
            { id: compVariantId, quantity: 1 }
          ]
        })
      });
      if (!res.ok) throw new Error('Add failed');
      msg.textContent = 'Beide Artikel liegen im Warenkorb.';
      btn.disabled = false;
      document.dispatchEvent(new CustomEvent('cart:refresh'));
    } catch(e) {
      msg.textContent = 'Konnte nicht hinzugefügt werden. Bitte erneut versuchen.';
      btn.disabled = false;
    }
  }

  // Initialisierung
  updateTotal();
  ensureCompExists();

  const sel = root.querySelector('[data-role="comp-variant"]');
  sel && sel.addEventListener('change', updateTotal);

  root.querySelector('[data-role="bundle-add"]').addEventListener('click', addBothToCart);
})();
</script>
